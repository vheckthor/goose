on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

name: CI

jobs:
  rust-format:
    name: Check Rust Code Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4

      - name: Run cargo fmt
        run: source ./bin/activate-hermit && cargo fmt --check

  rust-build-and-test:
    name: Build and Test Rust Project
    runs-on: ubuntu-latest
    steps:
          # Add disk space cleanup before linting
      - name: Check disk space before build
        run: df -h

      #https://github.com/actions/runner-images/issues/2840
      - name: Clean up disk space (parallelized)
        run: |
          echo "Cleaning up disk space in parallel..."

          dirs_to_delete=(
            "/opt/google/chrome"
            "/opt/microsoft/msedge"
            "/opt/microsoft/powershell"
            "/usr/lib/mono"
            "/usr/local/lib/android"
            "/usr/local/lib/node_modules"
            "/usr/local/share/chromium"
            "/usr/local/share/powershell"
            "/usr/share/dotnet"
            "/usr/share/swift"
          )

          for dir in "${dirs_to_delete[@]}"; do
            if [ -d "$dir" ]; then
              echo "Deleting $dir ..."
              sudo rm -rf "$dir" &
            else
              echo "$dir does not exist, skipping"
            fi
          done

          wait
          echo "Disk cleanup finished."
          df -h
          
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4

      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Cache Cargo Registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install and configure sccache
        run: |
          cargo binstall sccache --no-confirm
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV
          echo "SCCACHE_CACHE_SIZE=1500M" >> $GITHUB_ENV
          
      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      
      - name: Build and Test #add some comments
        run: |
          gnome-keyring-daemon --components=secrets --daemonize --unlock <<< 'foobar'
          source ../bin/activate-hermit && CARGO_INCREMENTAL=0 cargo test -j 1
        working-directory: crates

      - name: Show sccache stats
        run: |
          echo "ðŸ“Š sccache stats:"
          sccache --show-stats || echo "sccache not found or failed to report stats"

      # Add disk space cleanup before linting
      - name: Check disk space before cleanup
        run: df -h

      - name: Clean up disk space
        run: |
          echo "Cleaning up disk space..."
          # Remove debug artifacts that are no longer needed after tests
          rm -rf target/debug/deps
          rm -rf target/debug/build
          rm -rf target/debug/incremental
          # Clean npm cache if it exists
          npm cache clean --force || true
          # Clean apt cache
          sudo apt-get clean
          # Remove unnecessary large directories
          rm -rf ~/.cargo/registry/index || true
          # Remove docker images if any
          docker system prune -af || true
          # Remove unused packages
          sudo apt-get autoremove -y || true

      - name: Check disk space after cleanup
        run: df -h

      - name: Lint
        run: source ./bin/activate-hermit && cargo clippy -- -D warnings

  desktop-lint:
    name: Lint Electron Desktop App
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4

      - name: Install Dependencies
        run: source ../../bin/activate-hermit && npm ci
        working-directory: ui/desktop

      - name: Run Lint
        run: source ../../bin/activate-hermit && npm run lint:check
        working-directory: ui/desktop

  # Faster Desktop App build for PRs only
  bundle-desktop-unsigned:
    uses: ./.github/workflows/bundle-desktop.yml
    if: github.event_name == 'pull_request'
    with:
      signing: false
